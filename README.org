-*- mode: org -*-

* GNU/Linux

** Доступ

Для получения доступа пользователю по логину и паролю OpenVPN, оператору
необходимо предоставить привелегии в HMS.

[[https://user-images.githubusercontent.com/7709598/139689139-045d95eb-dcf2-457f-9bf9-0aab7196577e.png]]

** Настройка

Скопировать файлы по аналогичным в вашей системе путям:

- etc/openvpn/login.conf
- etc/openvpn/majordomo-ca.cert
- etc/openvpn/majordomo.conf

Поменять в /etc/openvpn/login.conf логин и пароль, после запустить сервис
OpenVPN:

#+begin_src sh
  systemctl enable openvpn@majordomo.service
  systemctl start openvpn@majordomo.service
#+end_src

** FAQ

*** Резолвинг доменных имен

В случае, если OpenVPN клиент не настроил резолвинг, то можно настроить в
ручную:

#+begin_example
  echo 'nameserver 172.16.102.2' | sudo tee /etc/resolv.conf
#+end_example

*** OpenVPN 2.5

https://www.opennet.ru/opennews/art.shtml?num=53981
#+begin_quote
Из конфигурации по умолчанию убрана поддержка шифра BF-CBC. В OpenVPN 2.5 по
умолчанию теперь принимаются только шифры AES-256-GCM и AES-128-GCM. Изменить
данное поведение можно при помощи опции data-ciphers, напрмер, указав в
настройках "data-ciphers AES-256-GCM:AES-128-GCM:BF-CBC", а для поддержки
очень старых узлов, не поддерживающих согласование шифров (режим "--cipher"),
можно указать "data-ciphers-fallback BF-CBC". При обновлении до новой версии
OpenVPN настройка "cipher BF-CBC" в старых файлах конфигурации будет
преобразована в добавление BF-CBC к набору data-ciphers и включён режим
data-ciphers-fallback.
#+end_quote

Тоесть необходимо добавить в файл =/etc/openvpn/majordomo.conf=:

#+begin_example
  data-ciphers AES-256-GCM:AES-128-GCM:BF-CBC
  data-ciphers-fallback BF-CBC
#+end_example

и перезапустить сервис OpenVPN:

#+begin_src sh
  sudo systemctl restart openvpn@majordomo.service
#+end_src

*** Ubuntu 22.04

#+begin_example
  ● openvpn-client@majordomo.service - OpenVPN tunnel for majordomo
       Loaded: loaded (/lib/systemd/system/openvpn-client@.service; disabled; vendor preset: enabled)
       Active: active (running) since Thu 2022-05-19 15:31:43 MSK; 2s ago
         Docs: man:openvpn(8)
               https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage
               https://community.openvpn.net/openvpn/wiki/HOWTO
     Main PID: 100452 (openvpn)
       Status: "Pre-connection initialization successful"
        Tasks: 1 (limit: 18912)
       Memory: 1.9M
          CPU: 14ms
       CGroup: /system.slice/system-openvpn\x2dclient.slice/openvpn-client@majordomo.service
               └─100452 /usr/sbin/openvpn --suppress-timestamps --nobind --config majordomo.conf
  мая 19 15:31:43 buh-4 openvpn[100452]: UDP link remote: [AF_INET]78.108.80.230:1194
  мая 19 15:31:43 buh-4 openvpn[100452]: TLS: Initial packet from [AF_INET]78.108.80.230:1194, sid=48a734f5 e71e6931
  мая 19 15:31:43 buh-4 openvpn[100452]: VERIFY ERROR: depth=0, error=CA signature digest algorithm too weak: C=RU, ST=RU, L=Saint-Petersburg, O=Majordomo Ltd., CN=office, emailAddress=sup>
  мая 19 15:31:43 buh-4 openvpn[100452]: OpenSSL: error:0A000086:SSL routines::certificate verify failed
  мая 19 15:31:43 buh-4 openvpn[100452]: TLS_ERROR: BIO read tls_read_plaintext error
  мая 19 15:31:43 buh-4 openvpn[100452]: TLS Error: TLS object -> incoming plaintext read error
  мая 19 15:31:43 buh-4 openvpn[100452]: TLS Error: TLS handshake failed
#+end_example

#+begin_example
  tls-cipher "DEFAULT:@SECLEVEL=0"
#+end_example

* Windows

1. Скачать и установить клиент [[https://swupdate.openvpn.org/community/releases/OpenVPN-2.5.4-I604-amd64.msi]]
2. Скачать файл https://raw.githubusercontent.com/mjuh/utils-openvpn/master/vpn_windows.ovpn и положить его в папку =C:\Program Files\OpenVPN\config= или в =C:\Users\YOUR_USER_NAME\OpenVPN\config=
3. Запустить клиент с ярылка OpenVPN Gui на рабочем столе.
4. Внизу в правой части панели должен быть значок монитора и замочка, по нему правой кнопкой нажать, появится меню, выбрать запустить. [[https://user-images.githubusercontent.com/7709598/147750708-c9588571-297e-430d-89d7-14f1da1a6ccc.png][Скриншот значка]]
5. В форме логина и пароля указать такие же логин и пароль как от https://hms-billing.intr/

* MacOS

1. Скачать и установить клиент [[https://tunnelblick.net/][Tunnelblick | Free open source OpenVPN VPN client server software for macOS]]
2. Скачать файл https://raw.githubusercontent.com/mjuh/utils-openvpn/master/vpn_windows.ovpn
3. Перенести конфигурационный файл в OpenVPN клиент.

Видео инструкция [[https://www.youtube.com/watch?v=a-MP7BkUPmM][MacOS OpenVPN tunnelblick.net - YouTube]]
